import{d as Q,n as X,m as de,e as a,ah as Z,ai as fe,a1 as H,R as U,t as Ve,aB as q,H as ze,Y as ve,a0 as pe,x as K,ak as ae,aC as Te,D as R,a4 as W,aD as Me,p as De,M as $e,aE as Le,r as V,K as ee,aF as Re,aG as Ne,y,aH as Y,aI as he,a as He,u as je,aJ as Ue,T as We,aK as Ee,c as O,b as m,aL as G,f as le,w as $,g as z,j as re,i,az as P,F as ie,ax as ce,k as J,o as B,al as Fe,an as Ke,h as Ge,ao as Je}from"./index-B_wq6Ifh.js";import{m as qe,u as Ye,c as Qe}from"./index-BfYoorWT.js";import{P as me,p as Xe,b as Ze,L as ge}from"./index-DBNQ_XEy.js";const[et,_]=de("action-sheet"),tt=X({},Xe,{title:String,round:H,actions:Ve(),closeIcon:U("cross"),closeable:H,cancelText:String,description:String,closeOnPopstate:H,closeOnClickAction:Boolean,safeAreaInsetBottom:H}),nt=[...Ze,"round","closeOnPopstate","safeAreaInsetBottom"];var ot=Q({name:et,props:tt,emits:["select","cancel","update:show"],setup(e,{slots:n,emit:l}){const v=t=>l("update:show",t),h=()=>{v(!1),l("cancel")},p=()=>{if(e.title)return a("div",{class:_("header")},[e.title,e.closeable&&a(q,{name:e.closeIcon,class:[_("close"),ze],onClick:h},null)])},c=()=>{if(n.cancel||e.cancelText)return[a("div",{class:_("gap")},null),a("button",{type:"button",class:_("cancel"),onClick:h},[n.cancel?n.cancel():e.cancelText])]},o=t=>{if(t.icon)return a(q,{class:_("item-icon"),name:t.icon},null)},u=(t,d)=>t.loading?a(ge,{class:_("loading-icon")},null):n.action?n.action({action:t,index:d}):[a("span",{class:_("name")},[t.name]),t.subname&&a("div",{class:_("subname")},[t.subname])],S=(t,d)=>{const{color:f,loading:g,callback:k,disabled:A,className:D}=t,I=()=>{A||g||(k&&k(t),e.closeOnClickAction&&v(!1),ve(()=>l("select",t,d)))};return a("button",{type:"button",style:{color:f},class:[_("item",{loading:g,disabled:A}),D],onClick:I},[o(t),u(t,d)])},b=()=>{if(e.description||n.description){const t=n.description?n.description():e.description;return a("div",{class:_("description")},[t])}};return()=>a(me,Z({class:_(),position:"bottom","onUpdate:show":v},fe(e,nt)),{default:()=>{var t;return[p(),b(),a("div",{class:_("content")},[e.actions.map(S),(t=n.default)==null?void 0:t.call(n)]),c()]}})}});const st=pe(ot);let L=0;function at(e){e?(L||document.body.classList.add("van-toast--unclickable"),L++):L&&(L--,L||document.body.classList.remove("van-toast--unclickable"))}const[lt,T]=de("toast"),rt=["show","overlay","teleport","transition","overlayClass","overlayStyle","closeOnClickOverlay","zIndex"],it={icon:String,show:Boolean,type:U("text"),overlay:Boolean,message:K,iconSize:K,duration:Te(2e3),position:U("middle"),teleport:[String,Object],wordBreak:String,className:ae,iconPrefix:String,transition:U("van-fade"),loadingType:String,forbidClick:Boolean,overlayClass:ae,overlayStyle:Object,closeOnClick:Boolean,closeOnClickOverlay:Boolean,zIndex:K};var we=Q({name:lt,props:it,emits:["update:show"],setup(e,{emit:n,slots:l}){let v,h=!1;const p=()=>{const t=e.show&&e.forbidClick;h!==t&&(h=t,at(h))},c=t=>n("update:show",t),o=()=>{e.closeOnClick&&c(!1)},u=()=>clearTimeout(v),S=()=>{const{icon:t,type:d,iconSize:f,iconPrefix:g,loadingType:k}=e;if(t||d==="success"||d==="fail")return a(q,{name:t||d,size:f,class:T("icon"),classPrefix:g},null);if(d==="loading")return a(ge,{class:T("loading"),size:f,type:k},null)},b=()=>{const{type:t,message:d}=e;if(l.message)return a("div",{class:T("text")},[l.message()]);if(De(d)&&d!=="")return t==="html"?a("div",{key:0,class:T("text"),innerHTML:String(d)},null):a("div",{class:T("text")},[d])};return R(()=>[e.show,e.forbidClick],p),R(()=>[e.show,e.type,e.message,e.duration],()=>{u(),e.show&&e.duration>0&&(v=setTimeout(()=>{c(!1)},e.duration))}),W(p),Me(p),()=>a(me,Z({class:[T([e.position,e.wordBreak==="normal"?"break-normal":e.wordBreak,{[e.type]:!e.icon}]),e.className],lockScroll:!1,onClick:o,onClosed:u,"onUpdate:show":c},fe(e,rt)),{default:()=>[S(),b()]})}});const ct={icon:"",type:"text",message:"",className:"",overlay:!1,onClose:void 0,onOpened:void 0,duration:2e3,teleport:"body",iconSize:void 0,iconPrefix:void 0,position:"middle",transition:"van-fade",forbidClick:!1,loadingType:void 0,overlayClass:"",overlayStyle:void 0,closeOnClick:!1,closeOnClickOverlay:!1};let j=[],ut=!1,ue=X({},ct);const dt=new Map;function ft(e){return Le(e)?e:{message:e}}function vt(){const{instance:e}=qe({setup(){const n=V(""),{open:l,state:v,close:h,toggle:p}=Ye(),c=()=>{},o=()=>a(we,Z(v,{onClosed:c,"onUpdate:show":p}),null);return R(n,u=>{v.message=u}),ee().render=o,{open:l,close:h,message:n}}});return e}function pt(){if(!j.length||ut){const e=vt();j.push(e)}return j[j.length-1]}function ht(e={}){if(!$e)return{};const n=pt(),l=ft(e);return n.open(X({},ue,dt.get(l.type||ue.type),l)),n}pe(we);function mt(e,n){return Re()?(Ne(e,n),!0):!1}const gt=typeof window<"u"&&typeof document<"u";typeof WorkerGlobalScope<"u"&&globalThis instanceof WorkerGlobalScope;function wt(e){return Array.isArray(e)?e:[e]}function bt(e){return ee()}function yt(e,n=!0,l){bt()?W(e,l):n?e():ve(e)}const be=gt?window:void 0;function M(e){var n;const l=he(e);return(n=l?.$el)!==null&&n!==void 0?n:l}function _t(){const e=Y(!1),n=ee();return n&&W(()=>{e.value=!0},n),e}function kt(e){const n=_t();return y(()=>(n.value,!!e()))}function Ct(e,n,l={}){const{window:v=be,...h}=l;let p;const c=kt(()=>v&&"ResizeObserver"in v),o=()=>{p&&(p.disconnect(),p=void 0)},u=R(y(()=>{const b=he(e);return Array.isArray(b)?b.map(t=>M(t)):[M(b)]}),b=>{if(o(),c.value&&v){p=new ResizeObserver(n);for(const t of b)t&&p.observe(t,h)}},{immediate:!0,flush:"post"}),S=()=>{o(),u()};return mt(S),{isSupported:c,stop:S}}function xt(e,n={width:0,height:0},l={}){const{window:v=be,box:h="content-box"}=l,p=y(()=>{var t;return(t=M(e))===null||t===void 0||(t=t.namespaceURI)===null||t===void 0?void 0:t.includes("svg")}),c=Y(n.width),o=Y(n.height),{stop:u}=Ct(e,([t])=>{const d=h==="border-box"?t.borderBoxSize:h==="content-box"?t.contentBoxSize:t.devicePixelContentBoxSize;if(v&&p.value){const f=M(e);if(f){const g=f.getBoundingClientRect();c.value=g.width,o.value=g.height}}else if(d){const f=wt(d);c.value=f.reduce((g,{inlineSize:k})=>g+k,0),o.value=f.reduce((g,{blockSize:k})=>g+k,0)}else c.value=t.contentRect.width,o.value=t.contentRect.height},l);yt(()=>{const t=M(e);t&&(c.value="offsetWidth"in t?t.offsetWidth:n.width,o.value="offsetHeight"in t?t.offsetHeight:n.height)});const S=R(()=>M(e),t=>{c.value=t?n.width:0,o.value=t?n.height:0});function b(){u(),S()}return{width:c,height:o,stop:b}}const St={class:"bg-gray-100 flex flex-col h-[100vh]"},It={class:"py-4 p-4 text-xl"},Ot={class:"relative"},Bt={class:"ml-4 my-2 text-2xl font-bold"},Pt={class:"my-2 py-1"},At={class:"ml-4"},Vt={class:"text-blue-500 text-base"},zt={class:"space-y-3"},Tt=["onClick"],Mt={class:"relative flex items-center h-16"},Dt={key:0,class:"flex items-center align-center pl-2 animate-spin"},$t={key:1,class:"pl-2"},Lt={class:"ml-auto mr-2"},Rt={class:"w-14 text-right"},Nt=["src"],Ht={class:"flex justify-between items-center m-4 h-12 text-base"},jt={class:"text-slate-500"},Ut=["disabled"],Kt=Q({__name:"Vote",async setup(e){let n,l;var v=He(),h=v.params.id,p=je(),c=([n,l]=Ue(()=>J.get("/vote/"+h)),n=await n,l(),n),o=We(c.data.result),u=V(!1),S=[{name:"复制链接",callback:function(){Qe(location.href),ht({message:"复制成功",position:"top"})}},{name:"分享给好友"},{name:"分享到朋友圈"}],b=o.vote.deadline;const t=new Date(b).toLocaleString();var d=y(()=>o.vote.multiple?"[多选]":"[单选]"),f=y(()=>{var s={};for(var r of o.options)s[r.optionId]=o.userVotes.filter(w=>w.optionId==r.optionId);return s}),g=y(()=>{var s=new Set(o.userVotes.map(C=>C.userId)).size,r={};for(let C in f.value){var w=f.value[C];r[C]=w.length>0?(w.length/s*100).toFixed(1)+"%":"0%"}return r}),k=y(()=>{var s={};for(let w in f.value){var r=f.value[w];r.some(C=>C.userId==p.user?.userId)?s[w]=!0:s[w]=!1}return s}),A=y(()=>{var s=new Date().toISOString();return s>o.vote.deadline}),D=y(()=>!(!o.vote.anonymous||A||o.vote.anonymous&&Object.values(k.value).some(s=>s==!0))),I=V([]),ye=y(()=>{if(D.value){let s={};for(let r of I.value)s[r]=!0;return s}return k.value}),te=V(null),_e=y(()=>te.value?.[0]),{width:ke}=xt(_e),Ce=y(()=>Math.floor((ke.value+8)/40)),xe=Ee();y(()=>Math.floor((xe.value.width-32+8)/40));var ne=V(new Array(o.options.length).fill(!1));function oe(s){let{optionId:r}=o.options[s];return ne.value[s]?f.value[r]:f.value[r].slice(0,Ce.value-1)}var E=V(!1),se=V(-1);function Se(s){if(!o.vote.anonymous)E.value=!0,se.value=s,J.post(`/vote/${o.vote.voteId}`,{optionIds:[s]}).then(w=>{E.value=!1,o.userVotes=w.data.result.userVotes});else if(D.value)if(I.value.includes(s)){var r=I.value.indexOf(s);I.value.splice(r,1)}else o.vote.multiple?I.value.push(s):I.value=[s];else alert("已投过票！")}function Ie(){J.post(`/vote/${o.vote.voteId}`,{optionIds:I.value}).then(s=>{o.userVotes=s.data.result.userVotes})}return W(()=>{var s=new WebSocket(`ws://${location.host}/realtime-voteinfo/${h}`);s.onmessage=r=>{var w=JSON.parse(r.data);o.userVotes=w}}),(s,r)=>{const w=z("House"),C=z("el-icon"),Oe=z("RouterLink"),Be=z("Share"),Pe=z("Loading"),Ae=z("More");return B(),O("div",St,[m("h1",It,[a(Oe,{to:"/"},{default:$(()=>[a(C,null,{default:$(()=>[a(w)]),_:1})]),_:1}),r[2]||(r[2]=le(" 腾讯投票 ",-1))]),m("div",Ot,[m("span",{class:"cursor-pointer bg-blue-500 text-white rounded-full w-10 h-10 absolute top-0 right-4 p-4 flex justify-center items-center",onClick:r[0]||(r[0]=x=>re(u)?u.value=!0:u=!0)},[a(C,{size:24},{default:$(()=>[a(Be)]),_:1})]),a(i(st),{show:i(u),"onUpdate:show":r[1]||(r[1]=x=>re(u)?u.value=x:u=x),"cancel-text":"取消",actions:i(S)},null,8,["show","actions"]),m("h2",Bt,P(i(o).vote.title),1),m("h3",Pt,[m("span",At,P(i(o).vote.desc),1),m("span",Vt,P(i(d)),1)])]),m("ul",zt,[(B(!0),O(ie,null,ce(i(o).options,(x,N)=>(B(),O("li",{class:"",key:N},[m("div",{class:Fe(["bg-white shadow px-4",{"cursor-default opacity-70":i(A)}]),onClick:F=>!i(A)&&Se(x.optionId)},[m("div",Mt,[le(P(x.content)+" ",1),i(E)&&x.optionId==i(se)?(B(),O("span",Dt,[a(C,null,{default:$(()=>[a(Pe)]),_:1})])):(B(),O("span",$t,P(i(ye)[x.optionId]?"✔️":""),1)),m("span",Lt,P(i(f)[x.optionId].length)+" 票",1),m("span",Rt,P(i(g)[x.optionId]),1),m("div",{class:"transition-all absolute bottom-0 bg-sky-500 h-[2px]",style:Ke({width:i(g)[x.optionId]})},null,4)])],10,Tt),i(o).vote.anonymous?G("",!0):(B(),O("div",{key:0,ref_for:!0,ref_key:"avatarContainer",ref:te,class:"flex flex-wrap gap-2 px-4 pt-2 mt-2"},[i(o).options&&i(o).options.length>0?(B(!0),O(ie,{key:0},ce(oe(N),F=>(B(),O("img",{class:"inline-block align-top w-8 h-8 rounded-full border border-slate-500",src:F.avatar},null,8,Nt))),256)):G("",!0),Ge(a(C,{class:"cursor-pointer inline-block align-top !w-8 !h-8 rounded-full border border-slate-500",onClick:F=>i(ne)[N]=!0},{default:$(()=>[a(Ae)]),_:1},8,["onClick"]),[[Je,oe(N).length>1]])],512))]))),128))]),m("div",Ht,[m("span",jt,"投票截止:"+P(i(t)),1),r[3]||(r[3]=m("span",{class:"text-slate-500"}," 吐个槽 | 举报投票 ",-1))]),i(D)?(B(),O("button",{key:0,onClick:Ie,disabled:i(I).length==0,class:"disabled:bg-gray-500 bg-blue-500 text-white rounded m-4 p-2 flex justify-center text-lg"}," 完成 ",8,Ut)):G("",!0)])}}});export{Kt as default};
